create trigger InsertAuditCustomer
    after update on customer
    for each row
begin
    DECLARE last_amount double;
    DECLARE last_rejection_date DATETIME;
    if(SELECT new.num_failed_payments from customer where id=new.id) > 2 and (SELECT count(*) FROM audit_customer WHERE id=new.id) = 0
    THEN
        SELECT total_monthly_fee into last_amount  FROM `order` WHERE id_user = new.id order by creation_date DESC LIMIT 1;
        SELECT creation_date into last_rejection_date  FROM `order` WHERE id_user = new.id order by creation_date DESC LIMIT 1;
        insert into audit_customer values (new.id, last_amount, last_rejection_date);
    end if;
end;