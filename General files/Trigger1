drop trigger if exists UpdateAmountStat_AFTER_INSERT;

create trigger UpdateAmountStat_AFTER_INSERT
    after insert on `order`
    for each row
begin
    declare idPackage int;
    declare validityPeriod int;
    declare monthlyFee double;
    select id_package, validity_period, monthly_fee into idPackage, validityPeriod, monthlyFee from offer where id = new.id_offer;

    if exists(SELECT * from stat_service_package where id_package = idPackage and validity_period = validityPeriod) then
        update stat_service_package set num_purchases = num_purchases + 1, tot_monthly_fee = stat_service_package.tot_monthly_fee + monthlyFee;
    else
        insert into stat_service_package(id_package, validity_period, num_purchases, tot_monthly_fee) values (idPackage, validityPeriod, 1, monthlyFee);
    end if;
end;

drop trigger if exists UpdateAmountOptionalStat_AFTER_INSERT;
create trigger UpdateAmountOptionalStat_AFTER_INSERT
    after insert on order_to_optional_product
    for each row
begin
    update stat_service_package set amount_for_optional_prods = amount_for_optional_prods + (select monthly_fee from optional_product where id = new.id_optional_product);
end;