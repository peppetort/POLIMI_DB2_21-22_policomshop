drop trigger if exists UpdatePurchasesStat_AFTER_INSERT;

create trigger UpdatePurchasesStat_AFTER_INSERT
    after insert on `order`
    for each row
begin
    declare idPackage int;
    declare validityPeriod int;
    select id_package, validity_period into idPackage, validityPeriod from offer where id = new.id_offer;

    if exists(SELECT * from stat_service_package where id_package = idPackage and validity_period = validityPeriod) then
        if  exists(select * from order_to_optional_product where id_order = idPackage) then
            update stat_service_package set num_purchases = num_purchases + 1, amount_with_optional = amount_with_optional + new.total_monthly_fee;
        else
            update stat_service_package set num_purchases = num_purchases + 1, amount_without_optional = amount_without_optional + new.total_monthly_fee;
        end if;
    else
        if  exists(select * from order_to_optional_product where id_order = new.id) then
            insert into stat_service_package values (idPackage, validityPeriod, 1, new.total_monthly_fee, 0);
        else
            insert into stat_service_package values (idPackage, validityPeriod, 1, 0, new.total_monthly_fee);
        end if;
    end if;
end;