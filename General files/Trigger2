drop trigger if exists UpdatePurchasesStatOptional_AFTER_INSERT;

create trigger UpdatePurchasesStatOptional_AFTER_INSERT
    after insert on order_to_optional_product
    for each row
begin
    declare idServicePackage int;
    select id_package into idServicePackage from offer where id in (select id_offer  from `order` where id = new.id_order);

    if exists(select * from stat_optional_package where id_optional = new.id_optional_product and id_package = idServicePackage) then
        update stat_optional_package set num_purchases = num_purchases + 1 where id_optional = new.id_optional_product and id_package = idServicePackage;
    else
        insert into stat_optional_package values (idServicePackage, new.id_optional_product, 1);
    end if;
end;